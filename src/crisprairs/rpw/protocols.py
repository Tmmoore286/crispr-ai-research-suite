"""Protocol generator: produces structured lab protocols from SessionContext."""

from __future__ import annotations

import logging
from datetime import datetime, timezone

from crisprairs.engine.context import SessionContext

logger = logging.getLogger(__name__)

# Common reagent catalog references for CRISPR experiments
REAGENT_CATALOG = {
    "SpCas9": {
        "plasmid": "Addgene #42230 (pX330-U6-Chimeric_BB-CBh-hSpCas9)",
        "protein": "IDT Alt-R S.p. Cas9 Nuclease V3 (Cat# 1081058)",
        "tracrRNA": "IDT Alt-R CRISPR-Cas9 tracrRNA (Cat# 1072532)",
    },
    "SaCas9": {
        "plasmid": "Addgene #61591 (pX601-AAV-CMV::NLS-SaCas9-NLS-3xHA-bGHpA)",
        "protein": "IDT Alt-R S.a. Cas9 Nuclease (Cat# 10006502)",
    },
    "enCas12a": {
        "plasmid": "Addgene #132416 (pCMV-T7-enAsCas12a-HF1)",
        "protein": "IDT Alt-R A.s. Cas12a (Cpf1) Ultra (Cat# 10001272)",
    },
    "SpRYCas9": {
        "plasmid": "Addgene #139987 (pCMV-T7-SpRY-P2A-EGFP)",
    },
    "CBE": {
        "plasmid": "Addgene #110396 (pCMV-BE4max)",
        "description": "Cytosine base editor (C-to-T conversion)",
    },
    "ABE": {
        "plasmid": "Addgene #112098 (pCMV-ABE7.10)",
        "description": "Adenine base editor (A-to-G conversion)",
    },
    "PE2": {
        "plasmid": "Addgene #132775 (pCMV-PE2)",
        "description": "Prime editor 2 (nickase-RT fusion)",
    },
    "PE3": {
        "plasmid": "Addgene #132775 (pCMV-PE2) + nicking sgRNA",
        "description": "Prime editor 3 (PE2 + nicking guide for higher efficiency)",
    },
    "dCas9-VP64": {
        "plasmid": "Addgene #61422 (pAC94-pmax-dCas9VP160-2A-puro)",
        "description": "Transcriptional activation via VP64 domain",
    },
    "dCas9-KRAB": {
        "plasmid": "Addgene #110820 (pLV-dCas9-KRAB-PuroR)",
        "description": "Transcriptional repression via KRAB domain",
    },
    "common": {
        "transfection": "Lipofectamine 3000 (Thermo Fisher Cat# L3000001)",
        "electroporation": "Lonza 4D-Nucleofector (Cat# AAF-1003B)",
        "culture_medium": "DMEM + 10% FBS + 1% Pen/Strep",
        "puromycin": "Puromycin dihydrochloride (Sigma Cat# P8833)",
        "T7E1": "T7 Endonuclease I (NEB Cat# M0302S)",
    },
}


class ProtocolGenerator:
    """Generates structured Markdown protocols from SessionContext."""

    @classmethod
    def generate(cls, ctx: SessionContext, session_id: str | None = None) -> str:
        """Generate a protocol from the session context.

        Returns a Markdown string with Materials, Steps, Controls, and
        Expected Results sections.
        """
        cas_system = ctx.cas_system or "Not specified"
        target_gene = ctx.target_gene or "Not specified"
        species = ctx.species or "Not specified"
        modality = cls._resolve_modality(ctx)

        delivery_method = ctx.delivery.method if ctx.delivery.method else "Not specified"
        delivery_format = ctx.delivery.format if ctx.delivery.format else "Not specified"
        delivery_product = ctx.delivery.product if ctx.delivery.product else ""

        now = datetime.now(timezone.utc).strftime("%Y-%m-%d")

        lines = [
            "# CRISPR Experiment Protocol",
            "",
            f"**Date Generated:** {now}",
        ]
        if session_id:
            lines.append(f"**Session ID:** {session_id}")
        lines.extend([
            f"**Target Gene:** {target_gene}",
            f"**Species:** {species}",
            f"**CRISPR System:** {cas_system}",
            f"**Modality:** {modality}",
            "",
            "---",
            "",
        ])

        if delivery_method != "Not specified":
            lines.extend([
                f"**Delivery Method:** {delivery_method}",
                f"**Delivery Format:** {delivery_format}",
                "",
            ])

        lines.extend(cls._materials_section(cas_system, modality))
        lines.append("")
        lines.extend(cls._sgrna_section(ctx))
        lines.append("")
        lines.extend(cls._steps_section(
            cas_system, target_gene, modality,
            delivery_method, delivery_format, delivery_product,
        ))
        lines.append("")
        lines.extend(cls._controls_section(target_gene, modality))
        lines.append("")
        lines.extend(cls._expected_results_section(modality))
        lines.append("")
        lines.append("---")
        lines.append("")
        lines.append("*Generated by CRISPR AI Research Suite Protocol Export.*")

        return "\n".join(lines)

    @classmethod
    def _resolve_modality(cls, ctx: SessionContext) -> str:
        """Determine the human-readable modality string."""
        m = (ctx.modality or "").lower()
        if "base" in m:
            return "Base Editing"
        if "prime" in m:
            return "Prime Editing"
        if m in ("activation", "repression"):
            return "CRISPRa/CRISPRi"
        return "Knockout"

    @classmethod
    def _materials_section(cls, cas_system, modality):
        lines = ["## Materials", ""]
        reagents = REAGENT_CATALOG.get(cas_system, {})
        common = REAGENT_CATALOG["common"]

        lines.append("### CRISPR Components")
        if reagents:
            for rtype, desc in reagents.items():
                if rtype != "description":
                    lines.append(f"- **{rtype.replace('_', ' ').title()}:** {desc}")
        else:
            lines.append(f"- {cas_system} expression construct (consult literature)")

        lines.append("")
        lines.append("### General Reagents")
        for rtype, desc in common.items():
            lines.append(f"- **{rtype.replace('_', ' ').title()}:** {desc}")

        return lines

    @classmethod
    def _sgrna_section(cls, ctx: SessionContext):
        lines = ["## sgRNA Sequences", ""]
        if not ctx.guides:
            lines.append("*No sgRNA data available from this session.*")
            return lines

        lines.append("| # | Sequence | Score | Source |")
        lines.append("|---|----------|-------|--------|")
        for i, g in enumerate(ctx.guides, 1):
            lines.append(f"| {i} | `{g.sequence}` | {g.score:.1f} | {g.source} |")
        return lines

    @classmethod
    def _steps_section(cls, cas_system, target_gene, modality,
                       delivery_method, delivery_format, delivery_product):
        lines = ["## Experimental Steps", ""]
        lines.append("### 1. Construct Preparation")
        lines.append(f"- Clone sgRNA oligos into the {cas_system} expression vector")
        lines.append("- Verify insert by Sanger sequencing")
        lines.append("")
        lines.append("### 2. Cell Culture")
        lines.append("- Maintain target cells in recommended culture medium")
        lines.append("- Passage cells to 70-80% confluency before transfection")
        lines.append("")
        lines.append("### 3. Delivery")

        if delivery_method == "lipofection":
            product_name = delivery_product or "Lipofectamine 3000"
            lines.append(
                f"- Transfect cells using {product_name}"
                " following manufacturer's protocol"
            )
            if delivery_format == "RNP":
                lines.append(
                    "- Pre-complex Cas9 protein with sgRNA"
                    " (1:1.2 molar ratio) for 10 min at RT"
                )
                lines.append(
                    f"- Mix RNP complex with {product_name} reagent"
                )
            else:
                lines.append(
                    f"- Use 500 ng {cas_system} plasmid"
                    " + 250 ng sgRNA plasmid per well (24-well)"
                )
        elif delivery_method == "electroporation":
            product_name = delivery_product or "Lonza 4D-Nucleofector"
            lines.append(f"- Electroporate cells using {product_name}")
            if delivery_format == "RNP":
                lines.append(
                    "- Pre-complex Cas9 protein with sgRNA"
                    " (1:1.2 molar ratio) for 10 min at RT"
                )
                lines.append(
                    "- Resuspend 2e5 cells in nucleofection"
                    " buffer, add RNP complex"
                )
            else:
                lines.append(
                    "- Resuspend 2e5 cells in nucleofection"
                    f" buffer with {cas_system} plasmid"
                )
            lines.append("- Use manufacturer-recommended program for your cell type")
        elif delivery_method == "lentiviral":
            lines.append("- Package sgRNA into lentiviral vector (e.g., lentiCRISPR v2)")
            lines.append("- Transduce target cells at MOI 0.3-0.5 for single-copy integration")
            lines.append("- Add polybrene (8 ug/mL) to enhance transduction efficiency")
        elif delivery_method == "AAV":
            serotype = delivery_product or "AAV"
            lines.append(f"- Package {cas_system} and sgRNA into {serotype} vector")
            lines.append("- Determine optimal MOI for your target tissue/cells")
            lines.append("- Administer virus at appropriate titer (typically 1e10-1e12 vg)")
        elif delivery_method == "LNP":
            lines.append(f"- Encapsulate {delivery_format} in lipid nanoparticles")
            if delivery_format == "mRNA":
                lines.append("- Co-encapsulate Cas9 mRNA and sgRNA in LNP formulation")
            else:
                lines.append("- Encapsulate RNP complex in LNP formulation")
            lines.append("- Administer at optimized dose for target tissue")
        else:
            lines.append("- Transfect cells using Lipofectamine 3000 or electroporation")

        lines.append("- Include untransfected control wells")
        lines.append("")
        lines.append("### 4. Selection (if applicable)")
        lines.append("- Add puromycin (1-3 ug/mL) 24h post-transfection")
        lines.append("- Maintain selection for 48-72h")
        lines.append("")
        lines.append("### 5. Validation")
        if modality == "Knockout":
            lines.append("- Extract genomic DNA 48-72h post-transfection")
            lines.append(f"- PCR amplify the {target_gene} target region")
            lines.append("- Perform T7 Endonuclease I (T7E1) assay or Sanger sequencing")
            lines.append(f"- Optionally confirm by Western blot for {target_gene} protein loss")
        elif modality == "Base Editing":
            lines.append("- Extract genomic DNA 72h post-transfection")
            lines.append(f"- PCR amplify the {target_gene} target region")
            lines.append("- Perform Sanger sequencing to verify base conversion")
            lines.append("- Quantify editing efficiency with EditR or CRISPResso2")
        elif modality == "Prime Editing":
            lines.append("- Extract genomic DNA 72h post-transfection")
            lines.append(f"- PCR amplify the {target_gene} target region")
            lines.append("- Perform deep sequencing to verify precise edit installation")
            lines.append("- Quantify editing efficiency with CRISPResso2")
        elif modality == "CRISPRa/CRISPRi":
            lines.append("- Extract RNA 48-72h post-transfection")
            lines.append(f"- Perform RT-qPCR to measure {target_gene} expression changes")
            lines.append("- Normalize to housekeeping gene (GAPDH or ACTB)")
        return lines

    @classmethod
    def _controls_section(cls, target_gene, modality):
        lines = ["## Controls", ""]
        lines.append("- **Negative control:** Non-targeting sgRNA (scrambled sequence)")
        lines.append("- **Untransfected control:** Cells without any construct")
        if modality == "Knockout":
            lines.append("- **Positive control:** Previously validated sgRNA (if available)")
        elif modality in ("Base Editing", "Prime Editing"):
            lines.append("- **Positive control:** Previously validated edit site (if available)")
        elif modality == "CRISPRa/CRISPRi":
            lines.append("- **Positive control:** sgRNA targeting a known responsive gene")
        return lines

    @classmethod
    def _expected_results_section(cls, modality):
        lines = ["## Expected Results", ""]
        if modality == "Knockout":
            lines.append("- T7E1 assay should show cleavage bands indicating indel formation")
            lines.append("- Expected editing efficiency: 20-80% depending on guide and cell type")
            lines.append("- Western blot should show reduced or absent protein expression")
        elif modality == "Base Editing":
            lines.append("- Sanger sequencing should show C-to-T or A-to-G conversion at target")
            lines.append("- Expected editing efficiency: 20-60% within the editing window")
            lines.append("- Minimal indel formation compared to nuclease-based editing")
        elif modality == "Prime Editing":
            lines.append("- Deep sequencing should show precise edit installation")
            lines.append("- Expected editing efficiency: 5-50% depending on pegRNA design")
            lines.append("- Low indel and off-target rates compared to HDR-based methods")
        elif modality == "CRISPRa/CRISPRi":
            lines.append("- RT-qPCR should show significant expression change vs controls")
            lines.append("- CRISPRa: expect 2-100x activation depending on system")
            lines.append("- CRISPRi: expect 50-95% repression depending on guide position")
        return lines
